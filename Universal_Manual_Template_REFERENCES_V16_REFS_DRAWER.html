<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Universal Manual Template</title>
    <style>
      :root {
        color-scheme: light;
        --rail-width: 320px;
        --brand: #2d5be3;
        --rail-bg: #111827;
        --rail-text: #f8fafc;
        --rail-muted: #9ca3af;
        --divider: rgba(255, 255, 255, 0.08);
        --surface: #f4f7fb;
        --surface-border: #d0d8e5;
        --heading: #111827;
        --body: #1f2937;
        --accent: #0ea5e9;
        --danger: #dc2626;
        --warning: #f59e0b;
        --success: #059669;
        font-family: "Inter", "Segoe UI", sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        display: grid;
        grid-template-columns: var(--rail-width) 1fr;
        min-height: 100vh;
        background: var(--surface);
        color: var(--body);
      }

      aside {
        background: var(--rail-bg);
        color: var(--rail-text);
        display: flex;
        flex-direction: column;
        padding: 20px 18px 28px;
        gap: 24px;
        position: sticky;
        top: 0;
        height: 100vh;
        overflow-y: auto;
      }

      .brand {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .brand input[type="text"] {
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(15, 23, 42, 0.6);
        color: var(--rail-text);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 16px;
      }

      .brand input[type="text"]::placeholder {
        color: rgba(248, 250, 252, 0.4);
      }

      .rail-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .rail-group h2 {
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin: 0;
        color: var(--rail-muted);
      }

      .section-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .section-entry {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        border: 1px solid transparent;
        border-radius: 8px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.05);
        position: relative;
        transition: background 0.15s, border-color 0.15s;
      }

      .section-entry:hover,
      .section-entry.is-active {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .section-entry.is-hidden {
        opacity: 0.5;
      }

      .section-title {
        flex: 1;
        text-align: left;
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
      }

      .menu-trigger {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: grid;
        place-items: center;
        font-size: 18px;
      }

      .menu-trigger:hover,
      .menu-trigger.is-open {
        background: rgba(255, 255, 255, 0.12);
      }

      .section-menu {
        position: absolute;
        right: 0;
        top: calc(100% + 6px);
        background: #1f2937;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        box-shadow: 0 18px 30px rgba(15, 23, 42, 0.3);
        padding: 8px 0;
        width: 180px;
        display: none;
        z-index: 20;
      }

      .section-entry.show-menu .section-menu {
        display: block;
      }

      .section-menu button {
        width: 100%;
        background: none;
        border: none;
        color: var(--rail-text);
        font: inherit;
        text-align: left;
        padding: 10px 16px;
        cursor: pointer;
      }

      .section-menu button:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      .add-section {
        border: 1px dashed rgba(255, 255, 255, 0.3);
        background: rgba(15, 23, 42, 0.7);
        color: var(--rail-text);
        border-radius: 8px;
        padding: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s, border-color 0.15s;
      }

      .add-section:hover {
        background: rgba(15, 23, 42, 0.9);
        border-color: rgba(255, 255, 255, 0.4);
      }

      .comment-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .comment-item {
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.05);
      }

      .comment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .comment-item-header strong {
        font-size: 13px;
      }

      .comment-item button {
        background: rgba(14, 165, 233, 0.2);
        color: #38bdf8;
        border: none;
        border-radius: 6px;
        padding: 6px 10px;
        font-weight: 600;
        cursor: pointer;
      }

      .comment-text {
        font-size: 13px;
        color: rgba(248, 250, 252, 0.88);
        margin-top: 6px;
        line-height: 1.5;
      }

      main {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      header {
        background: #fff;
        border-bottom: 1px solid var(--surface-border);
        padding: 18px 28px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 24px;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .file-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .file-meta h1 {
        font-size: 24px;
        margin: 0;
        color: var(--heading);
      }

      .file-meta small {
        color: #6b7280;
      }

      .primary-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .primary-actions button,
      .primary-actions .split {
        background: var(--brand);
        border: none;
        color: white;
        padding: 12px 18px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
      }

      .primary-actions button.secondary {
        background: #334155;
      }

      .primary-actions button:hover,
      .primary-actions .split:hover {
        filter: brightness(1.05);
      }

      .primary-actions .split {
        position: relative;
      }

      .primary-actions .split-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: #fff;
        border-radius: 12px;
        border: 1px solid var(--surface-border);
        box-shadow: 0 14px 36px rgba(15, 23, 42, 0.18);
        padding: 16px;
        width: 260px;
        display: none;
        z-index: 30;
        color: var(--body);
      }

      .primary-actions .split.open .split-menu {
        display: block;
      }

      .split-menu label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        font-size: 14px;
        margin-bottom: 12px;
      }

      .split-menu label:last-of-type {
        margin-bottom: 20px;
      }

      .split-menu input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .split-menu button {
        width: 100%;
        background: var(--brand);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
      }

      .editor {
        flex: 1;
        padding: 28px 32px 60px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .section-header-edit {
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #fff;
        border: 1px solid var(--surface-border);
        border-radius: 16px;
        padding: 24px;
      }

      .section-header-edit h2 {
        margin: 0;
        color: var(--heading);
      }

      .section-header-edit input[type="text"] {
        border: 1px solid var(--surface-border);
        border-radius: 10px;
        padding: 12px 14px;
        font-size: 18px;
      }

      .section-meta {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        font-size: 14px;
        color: #6b7280;
      }

      .subsection-card {
        background: #fff;
        border-radius: 16px;
        border: 1px solid var(--surface-border);
        padding: 20px 22px;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .subsection-card.is-hidden {
        border-style: dashed;
        opacity: 0.6;
      }

      .subsection-card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0;
        border: none;
        background: none;
        position: static;
      }

      .subsection-card header input[type="text"] {
        border: none;
        font-size: 18px;
        font-weight: 600;
        color: var(--heading);
        width: 100%;
      }

      .subsection-card header input[type="text"]:focus {
        outline: 2px solid rgba(45, 91, 227, 0.4);
        border-radius: 6px;
        padding: 2px 4px;
      }

      .subsection-body {
        border: 1px solid transparent;
        border-radius: 10px;
        padding: 16px;
        background: #f8fafc;
        min-height: 160px;
        line-height: 1.6;
        font-size: 15px;
      }

      .subsection-body:focus {
        border-color: rgba(45, 91, 227, 0.3);
        background: #fff;
        outline: none;
      }

      .empty-state {
        text-align: center;
        color: #6b7280;
        padding: 80px 0;
        font-size: 16px;
      }

      .selection-menu {
        position: fixed;
        background: #1f2937;
        color: #fff;
        border-radius: 10px;
        padding: 8px;
        display: none;
        gap: 6px;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.25);
        z-index: 1000;
      }

      .selection-menu button {
        background: none;
        border: none;
        color: inherit;
        font: inherit;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
      }

      .selection-menu button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .annotation-target {
        background: rgba(14, 165, 233, 0.3);
        border-radius: 4px;
        padding: 0 2px;
      }

      .annotation-target.revealed {
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.4);
        transition: box-shadow 0.2s ease;
      }

      .hidden-chunk {
        background: rgba(220, 38, 38, 0.15);
        color: transparent;
        text-shadow: 0 0 10px rgba(15, 23, 42, 0.45);
        border-radius: 3px;
        position: relative;
      }

      .hidden-chunk::after {
        content: "●";
        font-size: 10px;
        color: rgba(220, 38, 38, 0.7);
        margin-left: 2px;
      }

      .hidden-chunk.revealed {
        color: inherit;
        background: rgba(34, 197, 94, 0.18);
        text-shadow: none;
      }

      .toast {
        position: fixed;
        bottom: 28px;
        right: 28px;
        background: #111827;
        color: #f8fafc;
        padding: 14px 18px;
        border-radius: 10px;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.35);
        font-size: 15px;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
        z-index: 2000;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .print-buffer {
        position: fixed;
        top: -200vh;
        left: -200vw;
        width: 1200px;
        background: white;
        padding: 40px;
        pointer-events: none;
        visibility: hidden;
      }

      .print-section h2 {
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 8px;
      }

      .print-section h3 {
        margin-top: 20px;
        color: #1f2937;
      }

      .print-comments {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }

      .print-comments h4 {
        margin: 0 0 12px;
      }

      .print-comments ol {
        padding-left: 20px;
      }

      @media (max-width: 1080px) {
        body {
          grid-template-columns: 1fr;
        }

        aside {
          position: static;
          height: auto;
          flex-direction: column;
        }

        main {
          min-height: auto;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  </head>
  <body>
    <aside>
      <div class="brand">
        <input
          id="fileNameInput"
          type="text"
          placeholder="Manual name"
          aria-label="Manual name"
        />
      </div>

      <div class="rail-group">
        <h2>Sections</h2>
        <div id="sectionList" class="section-list" role="list"></div>
        <button id="addSectionBtn" class="add-section" type="button">
          + Section
        </button>
      </div>

      <div class="rail-group">
        <h2>Comments</h2>
        <div id="commentList" class="comment-list"></div>
      </div>
    </aside>

    <main>
      <header>
        <div class="file-meta">
          <h1 id="fileNameHeading">Manual</h1>
          <small id="sectionSubtitle">Select a section to begin editing.</small>
        </div>
        <div class="primary-actions">
          <button id="saveBtn" type="button">Save</button>
          <button id="saveAsBtn" class="secondary" type="button">Save As</button>
          <div id="printSplit" class="split" role="group" aria-haspopup="true">
            <span>Print</span>
            <svg width="12" height="12" viewBox="0 0 12 12" aria-hidden="true">
              <path
                d="M3 4.5L6 7.5L9 4.5"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path>
            </svg>
            <div class="split-menu" role="dialog" aria-modal="false">
              <label>
                Include comments
                <input id="printIncludeComments" type="checkbox" checked />
              </label>
              <label>
                Include hidden text
                <input id="printIncludeHidden" type="checkbox" />
              </label>
              <label>
                Secure (image-based) mode
                <input id="printSecureMode" type="checkbox" />
              </label>
              <button id="executePrintBtn" type="button">Print</button>
            </div>
          </div>
        </div>
      </header>

      <div id="editor" class="editor" aria-live="polite">
        <div class="empty-state">Select a section to start editing content.</div>
      </div>
    </main>

    <div id="selectionMenu" class="selection-menu" role="menu">
      <button id="selectionCommentBtn" type="button">Add comment</button>
      <button id="selectionToggleBtn" type="button">Hide</button>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <div id="printBuffer" class="print-buffer"></div>

    <script id="manualData" type="application/json">
      {
        "fileName": "Universal Manual Template",
        "sections": [
          {
            "id": "section-1",
            "title": "Level 1",
            "hidden": false,
            "subsections": [
              {
                "id": "section-1-sub-1",
                "title": "Introduction",
                "hidden": false,
                "content": "<p>Start writing content for Level 1 here.</p>"
              }
            ]
          },
          {
            "id": "section-2",
            "title": "Level 2",
            "hidden": false,
            "subsections": [
              {
                "id": "section-2-sub-1",
                "title": "Overview",
                "hidden": false,
                "content": "<p>Detail the requirements for Level 2.</p>"
              }
            ]
          },
          {
            "id": "section-3",
            "title": "Level 3",
            "hidden": false,
            "subsections": [
              {
                "id": "section-3-sub-1",
                "title": "Details",
                "hidden": false,
                "content": "<p>Capture advanced information for Level 3.</p>"
              }
            ]
          }
        ],
        "comments": []
      }
    </script>

    <script>
      const manualDataTag = document.getElementById("manualData");
      let manualState = {
        fileName: "Universal Manual Template",
        sections: [],
        comments: [],
      };

      try {
        const payload = manualDataTag.textContent.trim();
        if (payload) {
          manualState = JSON.parse(payload);
        }
      } catch (error) {
        console.error("Failed to parse manual data", error);
      }

      const sectionList = document.getElementById("sectionList");
      const commentList = document.getElementById("commentList");
      const addSectionBtn = document.getElementById("addSectionBtn");
      const fileNameInput = document.getElementById("fileNameInput");
      const fileNameHeading = document.getElementById("fileNameHeading");
      const sectionSubtitle = document.getElementById("sectionSubtitle");
      const editorContainer = document.getElementById("editor");
      const selectionMenu = document.getElementById("selectionMenu");
      const selectionCommentBtn = document.getElementById("selectionCommentBtn");
      const selectionToggleBtn = document.getElementById("selectionToggleBtn");
      const toast = document.getElementById("toast");
      const saveBtn = document.getElementById("saveBtn");
      const saveAsBtn = document.getElementById("saveAsBtn");
      const printSplit = document.getElementById("printSplit");
      const printIncludeComments = document.getElementById("printIncludeComments");
      const printIncludeHidden = document.getElementById("printIncludeHidden");
      const printSecureMode = document.getElementById("printSecureMode");
      const executePrintBtn = document.getElementById("executePrintBtn");
      const printBuffer = document.getElementById("printBuffer");

      let currentSectionId = manualState.sections[0]?.id || null;
      let currentFileHandle = null;
      let syncTimer = null;

      const uid = () =>
        typeof crypto !== "undefined" && crypto.randomUUID
          ? crypto.randomUUID()
          : `id-${Date.now().toString(16)}-${Math.random()
              .toString(16)
              .slice(2, 8)}`;

      function scheduleSync() {
        if (syncTimer) {
          clearTimeout(syncTimer);
        }
        syncTimer = setTimeout(() => {
          syncTimer = null;
          updateStateScript();
        }, 500);
      }

      function syncImmediately() {
        if (syncTimer) {
          clearTimeout(syncTimer);
          syncTimer = null;
        }
        updateStateScript();
      }

      function updateStateScript() {
        const sections = manualState.sections.map((section) => ({
          ...section,
          subsections: section.subsections.map((sub) => ({
            ...sub,
          })),
        }));
        const payload = {
          fileName: manualState.fileName,
          sections,
          comments: manualState.comments,
        };
        manualDataTag.textContent = JSON.stringify(payload, null, 2);
        document.title = manualState.fileName || "Manual";
      }

      function renderSections() {
        sectionList.innerHTML = "";
        manualState.sections.forEach((section) => {
          const entry = document.createElement("div");
          entry.className = "section-entry";
          if (section.id === currentSectionId) entry.classList.add("is-active");
          if (section.hidden) entry.classList.add("is-hidden");

          const button = document.createElement("button");
          button.className = "section-title";
          button.type = "button";
          button.textContent = section.title;
          button.addEventListener("click", () => {
            currentSectionId = section.id;
            renderSections();
            renderEditor();
          });

          const menuTrigger = document.createElement("button");
          menuTrigger.className = "menu-trigger";
          menuTrigger.type = "button";
          menuTrigger.setAttribute("aria-label", `Actions for ${section.title}`);
          menuTrigger.textContent = "⋮";

          const menu = document.createElement("div");
          menu.className = "section-menu";

          const hideBtn = document.createElement("button");
          hideBtn.type = "button";
          hideBtn.textContent = section.hidden ? "Show section" : "Hide section";
          hideBtn.addEventListener("click", () => {
            section.hidden = !section.hidden;
            if (section.hidden && section.id === currentSectionId) {
              currentSectionId = manualState.sections.find(
                (s) => !s.hidden
              )?.id;
            }
            renderSections();
            renderEditor();
            closeOpenMenus();
            scheduleSync();
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.textContent = "Delete section";
          deleteBtn.addEventListener("click", () => {
            if (
              confirm(
                `Delete section "${section.title}" and all its subsections?`
              )
            ) {
              manualState.sections = manualState.sections.filter(
                (item) => item.id !== section.id
              );
              if (section.id === currentSectionId) {
                currentSectionId = manualState.sections[0]?.id || null;
              }
              renderSections();
              renderEditor();
              scheduleSync();
            }
            closeOpenMenus();
          });

          const addSubBtn = document.createElement("button");
          addSubBtn.type = "button";
          addSubBtn.textContent = "Add subsection";
          addSubBtn.addEventListener("click", () => {
            const title = prompt("New subsection title", "New subsection");
            if (!title) {
              closeOpenMenus();
              return;
            }
            const subsection = {
              id: uid(),
              title,
              hidden: false,
              content: "<p>Write here…</p>",
            };
            section.subsections.push(subsection);
            renderEditor();
            scheduleSync();
            closeOpenMenus();
          });

          menu.appendChild(hideBtn);
          menu.appendChild(addSubBtn);
          menu.appendChild(deleteBtn);

          menuTrigger.setAttribute("aria-expanded", "false");
          menuTrigger.addEventListener("click", (event) => {
            event.stopPropagation();
            const isOpen = entry.classList.toggle("show-menu");
            menuTrigger.classList.toggle("is-open", isOpen);
            menuTrigger.setAttribute("aria-expanded", isOpen ? "true" : "false");
            if (isOpen) {
              closeOpenMenus(entry);
            }
          });

          entry.appendChild(button);
          entry.appendChild(menuTrigger);
          entry.appendChild(menu);
          sectionList.appendChild(entry);
        });
      }

      function closeOpenMenus(except) {
        document.querySelectorAll(".section-entry.show-menu").forEach((entry) => {
          if (entry === except) return;
          entry.classList.remove("show-menu");
          const trigger = entry.querySelector(".menu-trigger");
          if (trigger) {
            trigger.classList.remove("is-open");
            trigger.setAttribute("aria-expanded", "false");
          }
        });
        printSplit.classList.remove("open");
      }

      function renderEditor() {
        editorContainer.innerHTML = "";
        const section = manualState.sections.find((s) => s.id === currentSectionId);
        if (!section) {
          const empty = document.createElement("div");
          empty.className = "empty-state";
          empty.textContent = "Add a section to begin editing.";
          editorContainer.appendChild(empty);
          sectionSubtitle.textContent = "No section selected.";
          return;
        }

        sectionSubtitle.textContent = `${section.subsections.length} subsection${
          section.subsections.length === 1 ? "" : "s"
        }`;

        const sectionCard = document.createElement("div");
        sectionCard.className = "section-header-edit";

        const titleLabel = document.createElement("label");
        titleLabel.textContent = "Section title";
        titleLabel.style.fontSize = "14px";
        titleLabel.style.color = "#6b7280";

        const titleInput = document.createElement("input");
        titleInput.type = "text";
        titleInput.value = section.title;
        titleInput.addEventListener("input", () => {
          section.title = titleInput.value;
          renderSections();
          scheduleSync();
        });

        const sectionMeta = document.createElement("div");
        sectionMeta.className = "section-meta";
        const visibleBadge = document.createElement("span");
        visibleBadge.textContent = section.hidden ? "Hidden" : "Visible";
        sectionMeta.appendChild(visibleBadge);

        sectionCard.appendChild(titleLabel);
        sectionCard.appendChild(titleInput);
        sectionCard.appendChild(sectionMeta);

        editorContainer.appendChild(sectionCard);

        section.subsections.forEach((subsection) => {
          const card = document.createElement("article");
          card.className = "subsection-card";
          if (subsection.hidden) card.classList.add("is-hidden");
          card.dataset.subsectionId = subsection.id;

          const cardHeader = document.createElement("header");
          const headingInput = document.createElement("input");
          headingInput.type = "text";
          headingInput.value = subsection.title;
          headingInput.addEventListener("input", () => {
            subsection.title = headingInput.value;
            scheduleSync();
          });
          cardHeader.appendChild(headingInput);

          const toggleBtn = document.createElement("button");
          toggleBtn.type = "button";
          toggleBtn.textContent = subsection.hidden ? "Show" : "Hide";
          toggleBtn.style.background = "#e5e7eb";
          toggleBtn.style.border = "none";
          toggleBtn.style.borderRadius = "8px";
          toggleBtn.style.padding = "6px 12px";
          toggleBtn.style.cursor = "pointer";
          toggleBtn.addEventListener("click", () => {
            subsection.hidden = !subsection.hidden;
            renderEditor();
            scheduleSync();
          });
          cardHeader.appendChild(toggleBtn);

          card.appendChild(cardHeader);

          const body = document.createElement("div");
          body.className = "subsection-body";
          body.contentEditable = true;
          body.innerHTML = subsection.content;
          body.addEventListener("input", () => {
            subsection.content = body.innerHTML;
            scheduleSync();
          });
          card.appendChild(body);

          editorContainer.appendChild(card);
        });
      }

      function renderComments() {
        commentList.innerHTML = "";
        if (!manualState.comments.length) {
          const empty = document.createElement("div");
          empty.className = "comment-item";
          empty.style.opacity = "0.6";
          empty.textContent = "No comments yet.";
          commentList.appendChild(empty);
          return;
        }

        manualState.comments.forEach((comment, index) => {
          const item = document.createElement("div");
          item.className = "comment-item";

          const header = document.createElement("div");
          header.className = "comment-item-header";
          const title = document.createElement("strong");
          title.textContent = `Comment ${index + 1}`;

          const go = document.createElement("button");
          go.type = "button";
          go.textContent = "Go";
          go.addEventListener("click", () => {
            const target = document.querySelector(
              `[data-comment-id="${comment.id}"]`
            );
            if (target) {
              target.scrollIntoView({ behavior: "smooth", block: "center" });
              target.classList.add("revealed");
              setTimeout(() => target.classList.remove("revealed"), 1400);
            } else {
              showToast("Target not found. It may have been removed.");
            }
          });

          header.appendChild(title);
          header.appendChild(go);

          const text = document.createElement("div");
          text.className = "comment-text";
          text.textContent = comment.text;

          item.appendChild(header);
          item.appendChild(text);
          commentList.appendChild(item);
        });
      }

      function handleAddSection() {
        const title = prompt("Section title", `Section ${manualState.sections.length + 1}`);
        if (!title) return;
        const id = uid();
        const section = {
          id,
          title,
          hidden: false,
          subsections: [
            {
              id: uid(),
              title: "New subsection",
              hidden: false,
              content: "<p>Write here…</p>",
            },
          ],
        };
        manualState.sections.push(section);
        currentSectionId = id;
        renderSections();
        renderEditor();
        scheduleSync();
      }

      function showSelectionMenu() {
        const selection = window.getSelection();
        if (!selection || selection.isCollapsed || !selection.rangeCount) {
          selectionMenu.style.display = "none";
          return;
        }

        const range = selection.getRangeAt(0);
        const focusNode =
          range.commonAncestorContainer.nodeType === Node.ELEMENT_NODE
            ? range.commonAncestorContainer
            : range.commonAncestorContainer.parentElement;
        const editor = focusNode?.closest?.(".subsection-body");
        if (!editor) {
          selectionMenu.style.display = "none";
          return;
        }

        const hiddenWrapper = focusNode?.closest?.(".hidden-chunk");
        selectionToggleBtn.textContent = hiddenWrapper ? "Show" : "Hide";

        const rect = range.getBoundingClientRect();
        selectionMenu.style.display = "flex";
        selectionMenu.style.visibility = "hidden";

        requestAnimationFrame(() => {
          const menuHeight = selectionMenu.offsetHeight || 42;
          const menuWidth = selectionMenu.offsetWidth || 180;
          const top = rect.top + window.scrollY - menuHeight - 12;
          const left =
            rect.left + window.scrollX + rect.width / 2 - menuWidth / 2;
          selectionMenu.style.top = `${Math.max(top, 12)}px`;
          selectionMenu.style.left = `${Math.max(left, 12)}px`;
          selectionMenu.style.visibility = "visible";
        });
      }

      function hideSelectionMenu() {
        selectionMenu.style.display = "none";
      }

      function wrapSelection({ className, dataset }) {
        const selection = window.getSelection();
        if (!selection || !selection.rangeCount) return null;
        const range = selection.getRangeAt(0);
        if (range.collapsed) return null;
        const wrapper = document.createElement("span");
        wrapper.className = className;
        if (dataset) {
          Object.entries(dataset).forEach(([key, value]) => {
            wrapper.dataset[key] = value;
          });
        }
        try {
          range.surroundContents(wrapper);
        } catch (error) {
          alert(
            "Unable to wrap selection. Please make sure the selection is fully contained within a single subsection."
          );
          return null;
        }
        const subsectionId = wrapper.closest(".subsection-card")?.dataset?.subsectionId;
        if (subsectionId) {
          const section = manualState.sections.find((s) => s.id === currentSectionId);
          const subsection = section?.subsections.find((sub) => sub.id === subsectionId);
          if (subsection) {
            subsection.content = wrapper
              .closest(".subsection-body")
              .innerHTML;
            scheduleSync();
          }
        }
        return wrapper;
      }

      function unwrapElement(element) {
        const parent = element.parentNode;
        if (!parent) return;
        while (element.firstChild) {
          parent.insertBefore(element.firstChild, element);
        }
        parent.removeChild(element);
      }

      function handleAddComment() {
        const selection = window.getSelection();
        if (!selection || selection.isCollapsed) return;
        const text = prompt("Comment text");
        if (!text) return;
        const id = uid();
        const wrapper = wrapSelection({
          className: "annotation-target",
          dataset: { commentId: id },
        });
        if (!wrapper) return;
        manualState.comments.push({ id, text });
        renderComments();
        scheduleSync();
        hideSelectionMenu();
        showToast("Comment added");
      }

      function handleToggleHidden() {
        const selection = window.getSelection();
        if (!selection || selection.isCollapsed) return;
        const range = selection.getRangeAt(0);
        const focusNode =
          range.commonAncestorContainer.nodeType === Node.ELEMENT_NODE
            ? range.commonAncestorContainer
            : range.commonAncestorContainer.parentElement;
        const existing = focusNode?.closest?.(".hidden-chunk");
        if (existing) {
          unwrapElement(existing);
        } else {
          const wrapper = wrapSelection({ className: "hidden-chunk" });
          if (!wrapper) return;
        }
        const subsectionEl = focusNode?.closest?.(".subsection-card");
        if (subsectionEl) {
          const subsectionId = subsectionEl.dataset.subsectionId;
          const section = manualState.sections.find((s) => s.id === currentSectionId);
          const subsection = section?.subsections.find((sub) => sub.id === subsectionId);
          if (subsection) {
            subsection.content = subsectionEl.querySelector(".subsection-body").innerHTML;
            scheduleSync();
          }
        }
        hideSelectionMenu();
      }

      function showToast(message) {
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2600);
      }

      async function saveToHandle(handle) {
        const data = serializeDocument();
        if (!window.showSaveFilePicker && !handle) {
          triggerDownload(data, `${manualState.fileName || "manual"}.html`);
          showToast("Download started");
          return;
        }

        try {
          const writable = await handle.createWritable();
          await writable.write(data);
          await writable.close();
          showToast("Saved successfully");
        } catch (error) {
          console.error(error);
          showToast("Save failed");
        }
      }

      function triggerDownload(content, filename) {
        const blob = new Blob([content], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 0);
      }

      function serializeDocument() {
        syncImmediately();
        const clone = document.documentElement.cloneNode(true);
        const serialized = "<!DOCTYPE html>\n" + clone.outerHTML;
        return serialized;
      }

      async function handleSave() {
        try {
          if (currentFileHandle) {
            await saveToHandle(currentFileHandle);
            return;
          }
          if (window.showSaveFilePicker) {
            const handle = await window.showSaveFilePicker({
              suggestedName: `${manualState.fileName || "manual"}.html`,
              types: [
                {
                  description: "HTML Manual",
                  accept: { "text/html": [".html"] },
                },
              ],
            });
            currentFileHandle = handle;
            await saveToHandle(handle);
          } else {
            await saveToHandle(null);
          }
        } catch (error) {
          if (error.name !== "AbortError") {
            console.error(error);
            showToast("Save cancelled or failed");
          }
        }
      }

      async function handleSaveAs() {
        try {
          if (window.showSaveFilePicker) {
            const handle = await window.showSaveFilePicker({
              suggestedName: `${manualState.fileName || "manual"}.html`,
              types: [
                {
                  description: "HTML Manual",
                  accept: { "text/html": [".html"] },
                },
              ],
            });
            currentFileHandle = handle;
            await saveToHandle(handle);
          } else {
            const name = prompt(
              "File name",
              `${manualState.fileName || "manual"}.html`
            );
            if (!name) return;
            const data = serializeDocument();
            triggerDownload(data, name);
            showToast("Download started");
          }
        } catch (error) {
          if (error.name !== "AbortError") {
            console.error(error);
            showToast("Save cancelled or failed");
          }
        }
      }

      function buildPrintableContent({ includeComments, includeHidden }) {
        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.style.gap = "24px";
        wrapper.style.fontFamily = '"Inter", "Segoe UI", sans-serif';
        wrapper.style.color = "#1f2937";
        manualState.sections.forEach((section) => {
          if (section.hidden && !includeHidden) return;
          const sectionEl = document.createElement("section");
          sectionEl.className = "print-section";

          const heading = document.createElement("h2");
          heading.textContent = section.title;
          sectionEl.appendChild(heading);

          section.subsections.forEach((sub) => {
            if (sub.hidden && !includeHidden) return;
            const subHeading = document.createElement("h3");
            subHeading.textContent = sub.title;
            sectionEl.appendChild(subHeading);

            const body = document.createElement("div");
            body.innerHTML = sub.content;
            if (!includeComments) {
              body.querySelectorAll("[data-comment-id]").forEach((node) => {
                unwrapElement(node);
              });
            }
            if (includeHidden) {
              body.querySelectorAll(".hidden-chunk").forEach((node) => {
                node.classList.add("revealed");
              });
            } else {
              body.querySelectorAll(".hidden-chunk").forEach((node) => {
                unwrapElement(node);
              });
            }
            sectionEl.appendChild(body);
          });

          wrapper.appendChild(sectionEl);
        });

        if (includeComments && manualState.comments.length) {
          const commentsBlock = document.createElement("div");
          commentsBlock.className = "print-comments";
          const title = document.createElement("h4");
          title.textContent = "Comments";
          const list = document.createElement("ol");
          manualState.comments.forEach((comment) => {
            const item = document.createElement("li");
            item.textContent = comment.text;
            list.appendChild(item);
          });
          commentsBlock.appendChild(title);
          commentsBlock.appendChild(list);
          wrapper.appendChild(commentsBlock);
        }

        return wrapper;
      }

      async function runPrint({ includeComments, includeHidden, secureMode }) {
        syncImmediately();
        const content = buildPrintableContent({ includeComments, includeHidden });

        if (secureMode) {
          return runSecurePrint(content);
        }

        const printWindow = window.open("", "manual-print");
        if (!printWindow) {
          showToast("Pop-up blocked");
          return;
        }

        const styles = `
          body { font-family: 'Inter', 'Segoe UI', sans-serif; margin: 40px; color: #111827; }
          .print-section { margin-bottom: 32px; }
          .print-section h2 { font-size: 24px; margin-bottom: 16px; }
          .print-section h3 { font-size: 18px; margin: 18px 0 8px; }
          .print-comments { margin-top: 40px; }
          .print-comments h4 { font-size: 18px; margin-bottom: 12px; }
        `;

        printWindow.document.write(`<!DOCTYPE html><html><head><title>${
          manualState.fileName
        }</title><style>${styles}</style></head><body>${content.innerHTML}</body></html>`);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
      }

      async function runSecurePrint(content) {
        if (typeof html2canvas !== "function") {
          showToast("Secure print unavailable");
          return;
        }

        printBuffer.innerHTML = "";

        const clone = content.cloneNode(true);
        printBuffer.appendChild(clone);
        printBuffer.style.visibility = "visible";
        printBuffer.classList.add("capturing");

        try {
          const canvas = await html2canvas(clone, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff",
          });

          const image = canvas.toDataURL("image/png");
          const printWindow = window.open("", "manual-print-secure");
          if (!printWindow) {
            showToast("Pop-up blocked");
            return;
          }
          printWindow.document.write(`<!DOCTYPE html><html><head><title>${
            manualState.fileName
          }</title><style>body{margin:0;display:flex;align-items:center;justify-content:center;background:#fff;}img{max-width:100%;max-height:100vh;}</style></head><body><img src="${image}" alt="Manual"/></body></html>`);
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
        } catch (error) {
          console.error(error);
          showToast("Secure print failed");
        } finally {
          printBuffer.style.visibility = "hidden";
          printBuffer.classList.remove("capturing");
          printBuffer.innerHTML = "";
        }
      }

      function setupPrintMenu() {
        printSplit.addEventListener("click", (event) => {
          event.stopPropagation();
          printSplit.classList.toggle("open");
        });

        executePrintBtn.addEventListener("click", async () => {
          closeOpenMenus();
          await runPrint({
            includeComments: printIncludeComments.checked,
            includeHidden: printIncludeHidden.checked,
            secureMode: printSecureMode.checked,
          });
        });
      }

      function initialize() {
        fileNameInput.value = manualState.fileName || "";
        fileNameHeading.textContent = manualState.fileName || "Manual";
        document.title = manualState.fileName || "Manual";
        renderSections();
        renderEditor();
        renderComments();
      }

      fileNameInput.addEventListener("input", () => {
        manualState.fileName = fileNameInput.value;
        fileNameHeading.textContent = manualState.fileName || "Manual";
        scheduleSync();
      });

      document.addEventListener("click", (event) => {
        if (!event.target.closest(".section-entry")) {
          closeOpenMenus();
        }
        if (!event.target.closest("#selectionMenu")) {
          hideSelectionMenu();
        }
        if (!event.target.closest("#printSplit")) {
          printSplit.classList.remove("open");
        }
      });

      document.addEventListener("selectionchange", () => {
        setTimeout(showSelectionMenu, 0);
      });

      selectionCommentBtn.addEventListener("click", handleAddComment);
      selectionToggleBtn.addEventListener("click", handleToggleHidden);
      addSectionBtn.addEventListener("click", handleAddSection);
      saveBtn.addEventListener("click", handleSave);
      saveAsBtn.addEventListener("click", handleSaveAs);
      setupPrintMenu();

      initialize();
    </script>
  </body>
</html>
